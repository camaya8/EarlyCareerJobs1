{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="container mt-5">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <a href="{% url 'jobs.index' %}" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-left"></i> Back to Jobs
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8 mb-4">
      <!-- Job Header Card -->
      <div class="card shadow-sm mb-4">
        {% if template_data.job.image %}
        <img src="{{ template_data.job.image.url }}" class="card-img-top" alt="{{ template_data.job.title }}" style="height: 300px; object-fit: cover;">
        {% endif %}
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h2 class="card-title mb-2">{{ template_data.job.title }}</h2>
              {% if template_data.job.company %}
              <p class="text-muted mb-0">
                <i class="bi bi-building"></i> {{ template_data.job.company }}
              </p>
              {% endif %}
            </div>
            {% if template_data.can_edit or user.is_admin %}
            <div class="btn-group">
              <a href="{% url 'jobs.edit' id=template_data.job.id %}" class="btn btn-warning btn-sm">
                <i class="bi bi-pencil"></i> Edit
              </a>
              <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
            {% endif %}
          </div>

          <!-- Job Description -->
          <div class="mb-4">
            <h5 class="mb-3">
              <i class="bi bi-file-text"></i> Job Description
            </h5>
            <p class="text-secondary">{{ template_data.job.description }}</p>
          </div>

          <!-- Required Skills -->
          {% if template_data.job.skill_list %}
          <div class="mb-4">
            <h5 class="mb-3">
              <i class="bi bi-gear"></i> Required Skills
            </h5>
            <div class="skill-badge-group">
              {% for skill in template_data.job.skill_list %}
                <span class="skill-badge">{{ skill }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Job Details Sidebar Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> Job Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if template_data.job.city or template_data.job.state or template_data.job.country %}
            <div class="col-12">
              <p class="mb-1 text-muted small">
                <i class="bi bi-geo-alt"></i> Location
              </p>
              <p class="mb-0">
                {{ template_data.job.city }}{% if template_data.job.state %}, {{ template_data.job.state }}{% endif %}{% if template_data.job.country %}, {{ template_data.job.country }}{% endif %}
              </p>
            </div>
            {% endif %}

            {% if template_data.job.work_style %}
            <div class="col-12">
              <p class="mb-1 text-muted small">
                <i class="bi bi-laptop"></i> Work Style
              </p>
              <p class="mb-0">{{ template_data.job.get_work_style_display }}</p>
            </div>
            {% endif %}

            {% if template_data.job.salary_min or template_data.job.salary_max %}
            <div class="col-12">
              <p class="mb-1 text-muted small">
                <i class="bi bi-currency-dollar"></i> Salary Range
              </p>
              <p class="mb-0">
                {% if template_data.job.salary_min and template_data.job.salary_max %}
                  ${{ template_data.job.salary_min|floatformat:2 }} - ${{ template_data.job.salary_max|floatformat:2 }}
                {% elif template_data.job.salary_min %}
                  From ${{ template_data.job.salary_min|floatformat:2 }}
                {% elif template_data.job.salary_max %}
                  Up to ${{ template_data.job.salary_max|floatformat:2 }}
                {% endif %}
              </p>
            </div>
            {% endif %}

            <div class="col-12">
              <p class="mb-1 text-muted small">
                <i class="bi bi-globe"></i> Visa Sponsorship
              </p>
              <p class="mb-0">
                {% if template_data.job.visa_sponsorship %}
                  <span class="badge bg-success">Available</span>
                {% else %}
                  <span class="badge bg-secondary">Not Available</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Application Form or Status (for Job Seekers) -->
      {% if user.is_authenticated %}
        {% if user.is_job_seeker %}
          {% if not template_data.has_applied %}
            <!-- Application Form -->
            <div class="card shadow-sm mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                  <i class="bi bi-file-earmark-text"></i> Apply for This Position
                </h5>
              </div>
              <div class="card-body">
                <form method="POST" action="{% url 'jobs.start_application' id=template_data.job.id %}">
                  {% csrf_token %}
                  <div class="mb-3">
                    <label for="user_note" class="form-label fw-bold">
                      Tell us why you're a great fit:
                    </label>
                    <textarea 
                      name="user_note" 
                      id="user_note" 
                      rows="5" 
                      class="form-control" 
                      placeholder="Share your relevant experience, skills, and why you're interested in this role..."
                      required></textarea>
                    <div class="form-text">
                      Tip: Highlight how your skills match the job requirements above.
                    </div>
                  </div>
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                      <i class="bi bi-send"></i> Submit Application
                    </button>
                  </div>
                </form>
              </div>
            </div>
          {% else %}
            <!-- Already Applied -->
            <div class="alert alert-success shadow-sm mb-4" role="alert">
              <i class="bi bi-check-circle-fill"></i> 
              <strong>Application Submitted!</strong> You have already applied to this job. Good luck!
            </div>
          {% endif %}
        {% endif %}

        <!-- Recommended Candidates (for Recruiters/Admins) -->
        {% if user.is_recruiter or user.is_admin %}
          {% if template_data.recommended_candidates %}
          <div class="alert alert-info shadow-sm mb-4" role="alert">
            <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.style.display='none'"></button>
            <h5 class="alert-heading">
              <i class="bi bi-stars"></i> Recommended Candidates
            </h5>
            <p class="mb-3">These candidates have skills that match your job requirements:</p>
            <div class="d-flex overflow-auto gap-3 py-2" style="-webkit-overflow-scrolling: touch;">
              {% for rec in template_data.recommended_candidates %}
              <div class="card hover-shadow" style="min-width: 300px; flex: 0 0 auto;">
                <div class="card-body">
                  <h6 class="card-title mb-1">
                    {{ rec.user.get_full_name|default:rec.user.username }}
                  </h6>
                  <p class="text-muted small mb-2">
                    <i class="bi bi-calendar"></i> Applied: {{ rec.application.date|date:"M d, Y" }}
                  </p>
                  {% if rec.common_skills %}
                  <div class="mb-2">
                    <small class="text-muted">Matching Skills:</small>
                    <div class="skill-badge-group mt-1">
                      {% for skill in rec.common_skills %}
                      <span class="skill-badge-sm">{{ skill }}</span>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                  {% if rec.application.user_note %}
                  <p class="small text-secondary mb-2">
                    "{{ rec.application.user_note|truncatewords:20 }}"
                  </p>
                  {% endif %}
                  <a href="{% url 'profile.view' username=rec.user.username %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-person"></i> View Profile
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- All Applicants Section -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-people"></i> Applicants
                <span class="badge bg-secondary">{{ template_data.applications|length }}</span>
              </h5>
              {% if user.is_authenticated and user.is_recruiter %}
              <a href="{% url 'candidates.search' %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-search"></i> Search All Candidates
              </a>
              {% endif %}
            </div>
            <div class="card-body">
              {% if template_data.applications %}
              <div class="list-group list-group-flush">
                {% for application in template_data.applications %}
                <div class="list-group-item hover-shadow mb-2 rounded">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1">
                        <a href="{% url 'profile.view' username=application.user.username %}" class="text-decoration-none">
                          {{ application.user.get_full_name|default:application.user.username }}
                        </a>
                      </h6>
                      <small class="text-muted">
                        <i class="bi bi-envelope"></i> {{ application.user.email }}
                        {% if application.user.profile.phone_number %}
                        | <i class="bi bi-telephone"></i> {{ application.user.profile.phone_number }}
                        {% endif %}
                      </small>
                    </div>
                    <small class="text-muted">
                      <i class="bi bi-calendar"></i> {{ application.date|date:"M d, Y" }}
                    </small>
                  </div>

                  {% if application.status %}
                  <div class="mb-2">
                    <span class="badge 
                      {% if application.status == 'pending' %}bg-warning text-dark
                      {% elif application.status == 'accepted' %}bg-success
                      {% elif application.status == 'rejected' %}bg-danger
                      {% else %}bg-secondary{% endif %}">
                      {{ application.get_status_display }}
                    </span>
                  </div>
                  {% endif %}

                  {% if application.user_note %}
                  <div class="border-start border-3 border-primary ps-3 mb-3">
                    <small class="text-muted d-block mb-1">Cover Letter:</small>
                    <p class="mb-0 text-secondary">{{ application.user_note }}</p>
                  </div>
                  {% endif %}

                  <div class="btn-group" role="group">
                    <a href="{% url 'profile.view' username=application.user.username %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-person"></i> View Profile
                    </a>
                    {% if template_data.can_edit %}
                    <a href="{% url 'jobs.edit_applicant' job_id=template_data.job.id app_id=application.id %}" class="btn btn-sm btn-outline-warning">
                      <i class="bi bi-pencil"></i> Edit
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAppModal{{ application.id }}">
                      <i class="bi bi-trash"></i> Remove
                    </button>
                    {% endif %}
                  </div>

                  <!-- Delete Confirmation Modal -->
                  {% if template_data.can_edit %}
                  <div class="modal fade" id="deleteAppModal{{ application.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Confirm Removal</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to remove {{ application.user.username }}'s application?
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <form method="post" action="{% url 'jobs.delete_applicant' job_id=template_data.job.id app_id=application.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Remove</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">No applications yet. Share this job posting to attract candidates!</p>
              </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endif %}
    </div>
    <div class="col-md-6 mx-auto mb-3 text-center">
      {% if template_data.job.image.url != '' %}
        <img src="{{ template_data.job.image.url }}" class="rounded img-card-400" />
      {% endif %}
      
    </div>
  </div>
</div>

<!-- Delete Job Modal -->
{% if template_data.can_edit or user.is_admin %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this job posting? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'jobs.delete' id=template_data.job.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete Job</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
.hover-shadow {
  transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.skill-badge-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.skill-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background-color: #5D61EA;
  color: white;
  border-radius: 1rem;
  font-size: 0.85rem;
  font-weight: 500;
}

.skill-badge-sm {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  background-color: #e7e7ff;
  color: #5D61EA;
  border-radius: 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}
</style>

{% endblock content %}
