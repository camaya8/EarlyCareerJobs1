{% extends 'base.html' %}
{% load static %}
{% block content %}
<section class="job-page py-5">
  <div class="container">
    <div class="job-page-hero mb-4">
      <div class="job-page-hero__text">
        <h1 class="job-page-title">Find your next role</h1>
        {% with result_count=context.jobs|length %}
          <p class="job-page-subtitle">
            {% if result_count %}
              Showing {{ result_count }} {% if result_count == 1 %}position{% else %}positions{% endif %} based on your filters.
            {% else %}
              No jobs match your filters yet—adjust your search to uncover more opportunities.
            {% endif %}
          </p>
        {% endwith %}
      </div>
      {% if user.is_authenticated and user.is_recruiter %}
        <a href="{% url 'jobs.create' %}" class="btn btn-primary job-page-cta">Post a job</a>
      {% endif %}
    </div>

    <div class="row job-page-layout gy-4 gx-4">
      <aside class="col-12 col-lg-4 col-xl-3">
        <form method="get" class="job-filter-card">
          <div class="job-filter-card__header">
            <h2>Refine search</h2>
            <p>Use filters to focus on the work style, location, and salary range you prefer.</p>
          </div>
          <div class="job-filter-group">
            {{ context.form.title.label_tag }}
            {{ context.form.title }}
          </div>
          <div class="job-filter-group">
            {{ context.form.skills.label_tag }}
            {{ context.form.skills }}
          </div>
          <div class="job-filter-group">
            {{ context.form.work_style.label_tag }}
            {{ context.form.work_style }}
          </div>

          <div class="job-filter-group">
            <div class="job-filter-inline">
              <div>
                {{ context.form.city.label_tag }}
                {{ context.form.city }}
              </div>
              <div>
                {{ context.form.state.label_tag }}
                {{ context.form.state }}
              </div>
            </div>
            <div class="mt-3">
              {{ context.form.country.label_tag }}
              {{ context.form.country }}
            </div>
          </div>

          <div class="job-filter-group">
            <label class="form-label">Salary range</label>
            <div class="job-filter-inline">
              <div>
                {{ context.form.salary_min }}
              </div>
              <span class="range-divider">to</span>
              <div>
                {{ context.form.salary_max }}
              </div>
            </div>
          </div>

          <div class="job-filter-group job-filter-checkbox">
            {{ context.form.visa_sponsorship }}
            {{ context.form.visa_sponsorship.label_tag }}
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1 job-filter-submit">Search</button>
            <a href="{% url 'jobs.index' %}" class="btn btn-outline-secondary flex-grow-1">Reset</a>
          </div>
        </form>
      </aside>

      <div class="col-12 col-lg-8 col-xl-9">
        {% if template_data.recommendations_hidden %}
          <div class="alert alert-secondary d-flex justify-content-between align-items-center recommendation-alert" role="alert">
            <span>You dismissed your job recommendations. You can bring them back anytime.</span>
            <form method="post" action="{% url 'jobs.recommendations.show' %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn btn-primary btn-sm">Show recommendations</button>
            </form>
          </div>
        {% endif %}

        {% if user.is_authenticated and user.is_job_seeker and template_data.recommended_jobs %}
          <section id="recommended-panel" class="recommendations-panel position-relative mb-4">
            <form method="post" action="{% url 'jobs.recommendations.hide' %}" class="recommendations-panel__dismiss">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn-close" aria-label="Dismiss recommendations"></button>
            </form>
            <div class="recommendations-panel__header">
              <p class="recommendations-eyebrow mb-1">For you</p>
              <h4 class="mb-0">Recommended roles</h4>
            </div>
            <div class="recommendations-list">
              {% for rec in template_data.recommended_jobs %}
                <article class="recommendation-card">
                  <div class="recommendation-card__media">
                    <img src="{{ rec.job.image.url }}" alt="{{ rec.job.title }}">
                  </div>
                  <div class="recommendation-card__body">
                    <h5 class="recommendation-card__title">{{ rec.job.title }}</h5>
                    {% if rec.common_skills %}
                      <p class="recommendation-card__subtitle">Matching skills</p>
                      <div class="skill-badge-group">
                        {% for skill in rec.common_skills %}
                          <span class="skill-badge">{{ skill }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="recommendation-card__actions">
                    <a href="{% url 'jobs.show' id=rec.job.id %}" class="btn btn-outline-dark btn-sm">View job</a>
                    <form method="post" action="{% url 'jobs.start_application' id=rec.job.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="user_note" value="">
                      <button type="submit" class="btn btn-primary btn-sm recommendation-card__apply">Apply now</button>
                    </form>
                  </div>
                </article>
              {% endfor %}
            </div>
          </section>
        {% elif user.is_authenticated and user.is_job_seeker and template_data.recommendations_available and not template_data.recommendations_hidden %}
          <div class="alert alert-info" role="alert">
            We have job recommendations waiting. Update your filters or click “Show recommendations” to view them again.
          </div>
        {% endif %}

        <section class="job-results">
          <div class="job-results-header">
            <p class="job-results-eyebrow">Your matches</p>
            <h2 class="h5">Jobs you've saved or applied to</h2>
            <p class="job-results-description">Keep track of the opportunities you’re already interested in.</p>
          </div>
          <div class="job-card-grid">
            {% for job in context.user_jobs %}
              {% include 'jobs/partials/job_card.html' with job=job %}
            {% empty %}
              <p class="text-muted mb-0">You haven’t saved or applied to any roles that match these filters yet.</p>
            {% endfor %}
          </div>
        </section>

        <section class="job-results mt-4">
          <div class="job-results-header">
            <p class="job-results-eyebrow">More to explore</p>
            <h2 class="h5">Discover additional opportunities</h2>
            <p class="job-results-description">Browse other openings that align with your current filters.</p>
          </div>
          <div class="job-card-grid">
            {% for job in context.other_jobs %}
              {% include 'jobs/partials/job_card.html' with job=job %}
            {% empty %}
              <p class="text-muted mb-0">No additional roles match right now. Try broadening your search.</p>
            {% endfor %}
          </div>
        </section>
      </div>
    </div>
  </div>
</section>
{% endblock content %}
