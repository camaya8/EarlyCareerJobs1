{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="container mt-5">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h1 class="display-4 fw-bold" style="color: #5D61EA;">Find Your Dream Job</h1>
      <p class="lead text-muted">Discover exciting career opportunities tailored for you</p>
    </div>
  </div>

  <!-- Filter Card -->
  <div class="card shadow-sm mb-5">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-funnel"></i> Filter Jobs
      </h5>
    </div>
    <div class="card-body">
      <form method="get" id="searchForm">
        <!-- Row 1: Job Title and Skills with Mode -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_title" class="form-label fw-bold">Job Title</label>
            {{ context.form.title }}
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Skills (comma-separated or click suggestions)</label>
            <div class="position-relative">
              {{ context.form.skills }}
              <input list="skillSuggestions" class="form-control" placeholder="Type or select skills..." id="skillInput" autocomplete="off">
              <datalist id="skillSuggestions">
                {% for skill in template_data.all_skills %}
                  <option value="{{ skill }}">
                {% endfor %}
              </datalist>
              
              <!-- Skills Chips Display -->
              <div id="skillsChips" class="mt-2 d-flex flex-wrap gap-2">
                {% for skill in template_data.active_skills %}
                  <span class="badge bg-primary d-flex align-items-center gap-1 skill-chip" style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                    {{ skill }}
                    <input type="hidden" name="skill" value="{{ skill }}">
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" onclick="removeSkill(this)" aria-label="Remove"></button>
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Skills Match Mode -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">Skills Match Mode</label>
            <select name="skills_mode" class="form-select" onchange="this.form.submit()">
              <option value="AND" {% if template_data.skills_mode == 'AND' %}selected{% endif %}>Match ALL skills (AND)</option>
              <option value="OR" {% if template_data.skills_mode == 'OR' %}selected{% endif %}>Match ANY skill (OR)</option>
            </select>
          </div>
        </div>

        <!-- Row 2: Location Fields -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="id_city" class="form-label fw-bold">City</label>
            {{ context.form.city }}
          </div>
          <div class="col-md-4">
            <label for="id_state" class="form-label fw-bold">State</label>
            {{ context.form.state }}
          </div>
          <div class="col-md-4">
            <label for="id_country" class="form-label fw-bold">Country</label>
            {{ context.form.country }}
          </div>
        </div>

        <!-- Row 3: Salary Range -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_salary_min" class="form-label fw-bold">Minimum Salary ($)</label>
            {{ context.form.salary_min }}
          </div>
          <div class="col-md-6">
            <label for="id_salary_max" class="form-label fw-bold">Maximum Salary ($)</label>
            {{ context.form.salary_max }}
          </div>
        </div>

        <!-- Row 4: Work Style and Visa -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="id_work_style" class="form-label fw-bold">Work Style</label>
            {{ context.form.work_style }}
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
              {{ context.form.visa_sponsorship }}
              <label class="form-check-label fw-bold" for="{{ context.form.visa_sponsorship.id_for_label }}">
                Visa Sponsorship Required
              </label>
            </div>
          </div>
        </div>

        <!-- Row 5: Action Buttons -->
        <div class="row">
          <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-search"></i> Search
            </button>
            <a href="{% url 'jobs.index' %}" class="btn btn-outline-secondary px-4">
              <i class="bi bi-arrow-clockwise"></i> Reset
            </a>
            {% if user.is_authenticated and user.is_recruiter %}
              <a href="{% url 'jobs.create' %}" class="btn btn-success px-4">
                <i class="bi bi-plus-circle"></i> Post a Job
              </a>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Recommended Jobs Section (for job seekers) -->
  {% if template_data.recommended_jobs %}
  <div class="alert alert-info shadow-sm mb-4" role="alert">
    <h5 class="alert-heading">
      <i class="bi bi-stars"></i> Recommended for You
    </h5>
    <p class="mb-3">These jobs match your skills profile:</p>
    <div class="row g-3">
      {% for rec in template_data.recommended_jobs %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 hover-shadow">
            {% if rec.job.image %}
              <img src="{{ rec.job.image.url }}" class="card-img-top" alt="{{ rec.job.title }}" style="height: 200px; object-fit: cover;">
            {% endif %}
            <div class="card-body">
              <h6 class="card-title">{{ rec.job.title }}</h6>
              {% if rec.job.company %}
                <p class="text-muted small mb-2">
                  <i class="bi bi-building"></i> {{ rec.job.company }}
                </p>
              {% endif %}
              {% if rec.common_skills %}
                <div class="mb-2">
                  <small class="text-muted">Matching Skills:</small>
                  <div class="skill-badge-group mt-1">
                    {% for skill in rec.common_skills %}
                      <span class="skill-badge-sm">{{ skill }}</span>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
              {% if rec.job.salary_min or rec.job.salary_max %}
                <p class="small text-success mb-2">
                  <i class="bi bi-currency-dollar"></i>
                  {% if rec.job.salary_min and rec.job.salary_max %}
                    ${{ rec.job.salary_min|floatformat:2 }} - ${{ rec.job.salary_max|floatformat:2 }}
                  {% elif rec.job.salary_min %}
                    From ${{ rec.job.salary_min|floatformat:2 }}
                  {% elif rec.job.salary_max %}
                    Up to ${{ rec.job.salary_max|floatformat:2 }}
                  {% endif %}
                </p>
              {% endif %}
              <a href="{% url 'jobs.show' id=rec.job.id %}" class="btn btn-sm btn-primary w-100">
                <i class="bi bi-eye"></i> View Details
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- My Posted Jobs (for recruiters) -->
  {% if user.is_authenticated and user.is_recruiter %}
    <div class="mb-5">
      <h4 class="mb-3">
        <i class="bi bi-briefcase"></i> My Posted Jobs
      </h4>
      <div class="row g-3">
        {% for job in context.jobs %}
          {% if user in job.users.all %}
            <div class="col-md-6 col-lg-4">
              <div class="card h-100 hover-shadow">
                {% if job.image %}
                  <img src="{{ job.image.url }}" class="card-img-top" alt="{{ job.title }}" style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body">
                  <h6 class="card-title">{{ job.title }}</h6>
                  {% if job.company %}
                    <p class="text-muted small mb-2">
                      <i class="bi bi-building"></i> {{ job.company }}
                    </p>
                  {% endif %}
                  {% if job.skill_list %}
                    <div class="skill-badge-group mb-2">
                      {% for skill in job.skill_list %}
                        <span class="skill-badge-sm">{{ skill }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                  {% if job.salary_min or job.salary_max %}
                    <p class="small text-success mb-2">
                      <i class="bi bi-currency-dollar"></i>
                      {% if job.salary_min and job.salary_max %}
                        ${{ job.salary_min|floatformat:2 }} - ${{ job.salary_max|floatformat:2 }}
                      {% elif job.salary_min %}
                        From ${{ job.salary_min|floatformat:2 }}
                      {% elif job.salary_max %}
                        Up to ${{ job.salary_max|floatformat:2 }}
                      {% endif %}
                    </p>
                  {% endif %}
                  <div class="d-flex gap-2">
                    <a href="{% url 'jobs.show' id=job.id %}" class="btn btn-sm btn-primary flex-grow-1">
                      <i class="bi bi-eye"></i> View
                    </a>
                    {% if user.is_admin %}
                      <a href="{% url 'jobs.edit' id=job.id %}" class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form method="post" action="{% url 'jobs.delete' id=job.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- All Available Jobs -->
  <div class="mb-5">
    <h4 class="mb-3">
      <i class="bi bi-list-ul"></i> Available Jobs
      <span class="badge bg-secondary">{{ context.jobs|length }}</span>
    </h4>
    <div class="row g-3">
      {% for job in context.jobs %}
        {% if not user.is_authenticated or not user.is_recruiter or user not in job.users.all %}
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 hover-shadow">
              {% if job.image %}
                <img src="{{ job.image.url }}" class="card-img-top" alt="{{ job.title }}" style="height: 200px; object-fit: cover;">
              {% endif %}
              <div class="card-body">
                <h6 class="card-title">{{ job.title }}</h6>
                {% if job.company %}
                  <p class="text-muted small mb-2">
                    <i class="bi bi-building"></i> {{ job.company }}
                  </p>
                {% endif %}
                {% if job.city or job.state or job.country %}
                  <p class="small text-secondary mb-2">
                    <i class="bi bi-geo-alt"></i>
                    {{ job.city }}{% if job.state %}, {{ job.state }}{% endif %}{% if job.country %}, {{ job.country }}{% endif %}
                  </p>
                {% endif %}
                {% if job.skill_list %}
                  <div class="skill-badge-group mb-2">
                    {% for skill in job.skill_list %}
                      <span class="skill-badge-sm">{{ skill }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                {% if job.salary_min or job.salary_max %}
                  <p class="small text-success mb-2">
                    <i class="bi bi-currency-dollar"></i>
                    {% if job.salary_min and job.salary_max %}
                      ${{ job.salary_min|floatformat:2 }} - ${{ job.salary_max|floatformat:2 }}
                    {% elif job.salary_min %}
                      From ${{ job.salary_min|floatformat:2 }}
                    {% elif job.salary_max %}
                      Up to ${{ job.salary_max|floatformat:2 }}
                    {% endif %}
                  </p>
                {% endif %}
                <a href="{% url 'jobs.show' id=job.id %}" class="btn btn-sm btn-primary w-100">
                  <i class="bi bi-eye"></i> View Details
                </a>
              </div>
            </div>
          </div>
        {% endif %}
      {% empty %}
        <div class="col-12">
          <div class="alert alert-warning text-center" role="alert">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-3 mb-0">No jobs match your search criteria. Try adjusting your filters.</p>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Skills Chips JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skillInput = document.getElementById('skillInput');
  const skillsChips = document.getElementById('skillsChips');
  const searchForm = document.getElementById('searchForm');
  const hiddenSkillsInput = document.querySelector('input[name="skills"]');

  // Handle skill input
  skillInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      addSkill(this.value.trim());
      this.value = '';
    }
  });

  skillInput.addEventListener('input', function() {
    const value = this.value.trim();
    if (value.endsWith(',')) {
      addSkill(value.slice(0, -1).trim());
      this.value = '';
    }
  });

  // Handle datalist selection
  skillInput.addEventListener('change', function() {
    if (this.value) {
      addSkill(this.value.trim());
      this.value = '';
    }
  });

  function addSkill(skill) {
    if (!skill) return;
    
    // Check if skill already exists
    const existingSkills = Array.from(skillsChips.querySelectorAll('input[name="skill"]')).map(input => input.value);
    if (existingSkills.includes(skill)) return;

    // Create chip
    const chip = document.createElement('span');
    chip.className = 'badge bg-primary d-flex align-items-center gap-1 skill-chip';
    chip.style.fontSize = '0.9rem';
    chip.style.padding = '0.5rem 0.75rem';
    chip.innerHTML = `
      ${skill}
      <input type="hidden" name="skill" value="${skill}">
      <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" onclick="removeSkill(this)" aria-label="Remove"></button>
    `;
    skillsChips.appendChild(chip);
    
    // Auto-submit
    searchForm.submit();
  }
});

function removeSkill(button) {
  button.closest('.skill-chip').remove();
  document.getElementById('searchForm').submit();
}
</script>

<style>
.hover-shadow {
  transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.skill-badge-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.skill-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background-color: #5D61EA;
  color: white;
  border-radius: 1rem;
  font-size: 0.85rem;
  font-weight: 500;
}

.skill-badge-sm {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  background-color: #e7e7ff;
  color: #5D61EA;
  border-radius: 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.skill-chip {
  cursor: default;
}
</style>

{% endblock content %}
