{% extends 'base.html' %}
{% load static %}
{% block content %}
<section class="job-search-page py-4">
  <div class="container">
    <div class="job-search-hero mb-4">
      <div class="job-search-hero__text">
        <h1 class="job-search-title">Find your next role</h1>
        {% with result_count=context.jobs|length %}
          <p class="job-search-subtitle">
            {% if result_count %}
              Showing {{ result_count }} {% if result_count == 1 %}position{% else %}positions{% endif %} based on your filters.
            {% else %}
              No jobs match your filters yet—adjust your search to see more roles.
            {% endif %}
          </p>
        {% endwith %}
      </div>
      {% if user.is_authenticated and user.is_recruiter %}
        <a href="{% url 'jobs.create' %}" class="btn btn-primary job-search-hero__cta">Post a job</a>
      {% endif %}
    </div>

    <div class="row job-search-layout gy-4 gx-4">
      <aside class="col-12 col-lg-4 col-xl-3">
        <form method="get" class="job-filter-card">
          <div class="job-filter-card__header">
            <h2>Refine search</h2>
            <p>Focus on what matters to you.</p>
          </div>
          <div class="job-filter-group">
            {{ context.form.title.label_tag }}
            {{ context.form.title }}
          </div>
          <div class="job-filter-group">
            <label class="form-label fw-bold">
              <i class="bi bi-star"></i> Skills:
            </label>
            <div class="position-relative">
              <!-- Hidden field for form submission -->
              <input type="hidden" name="skills" value="">
              
              <!-- Visible input for typing skills -->
              <input list="skillSuggestions" class="form-control" placeholder="Enter or Select Skills" id="skillInput" autocomplete="off">
              <datalist id="skillSuggestions">
                {% for skill in template_data.all_skills %}
                  <option value="{{ skill }}">
                {% endfor %}
              </datalist>
              
              <!-- Skills Chips Display -->
              <div id="skillsChips" class="mt-2 d-flex flex-wrap gap-2 skill-badge-group">
                {% for skill in template_data.active_skills %}
                  <span class="skill-badge d-flex align-items-center gap-1 skill-chip" style="font-size: 0.9rem; padding: 0.5rem 0.75rem; cursor: pointer;">
                    {{ skill }}&nbsp;
                    <input type="hidden" name="skill" value="{{ skill }}">
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" onclick="removeSkill(this)" aria-label="Remove"></button>
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
          
          <div class="job-filter-group">
            <label class="form-label">Skills Match Mode</label>
            <select name="skills_mode">
              <option value="AND" {% if template_data.skills_mode == 'AND' %}selected{% endif %}>Match ALL (AND)</option>
              <option value="OR" {% if template_data.skills_mode == 'OR' %}selected{% endif %}>Match ANY (OR)</option>
            </select>
          </div>
          
          <div class="job-filter-group">
            {{ context.form.work_style.label_tag }}
            {{ context.form.work_style }}
          </div>

          <div class="job-filter-group">
            <div class="job-filter-inline">
              <div>
                {{ context.form.city.label_tag }}
                {{ context.form.city }}
              </div>
              <div>
                {{ context.form.state.label_tag }}
                {{ context.form.state }}
              </div>
            </div>
            <div class="mt-3">
              {{ context.form.country.label_tag }}
              {{ context.form.country }}
            </div>
          </div>

          <div class="job-filter-group">
            <label class="form-label">Salary range:</label>
            <div class="job-filter-inline">
              <div>
                {{ context.form.salary_min }}
              </div>
              <span class="range-divider">to</span>
              <div>
                {{ context.form.salary_max }}
              </div>
            </div>
          </div>

          <div class="job-filter-group job-filter-checkbox">
            {{ context.form.visa_sponsorship }}
            {{ context.form.visa_sponsorship.label_tag }}
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1 job-filter-submit">Search</button>
            <a href="{% url 'jobs.index' %}" class="btn btn-outline-secondary flex-grow-1">Reset</a>
          </div>
        </form>
      </aside>

      <div class="col-12 col-lg-8 col-xl-9">
        {% if template_data.recommendations_hidden %}
          <div class="alert alert-secondary d-flex justify-content-between align-items-center recommendation-alert" role="alert">
            <span>You dismissed your job recommendations. You can bring them back anytime.</span>
            <form method="post" action="{% url 'jobs.recommendations.show' %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn btn-primary btn-sm recommendation-alert__button">Show recommendations</button>
            </form>
          </div>
        {% endif %}

        {% if user.is_authenticated and user.is_job_seeker and template_data.recommended_jobs %}
          <section id="recommended-panel" class="recommendations-panel position-relative mb-4">
            <form method="post" action="{% url 'jobs.recommendations.hide' %}" class="recommendations-panel__dismiss">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn-close" aria-label="Dismiss recommendations"></button>
            </form>

            <div class="recommendations-panel__header">
              <p class="recommendations-eyebrow mb-1">Tailored for you</p>
              <h4 class="mb-0">Recommended Jobs</h4>
            </div>
            <div class="recommendations-list">
              {% for rec in template_data.recommended_jobs %}
                <article class="recommendation-card">
                  <div class="recommendation-card__media">
                    <img src="{{ rec.job.image.url }}" alt="{{ rec.job.title }}">
                  </div>
                  <div class="recommendation-card__body">
                    <h5 class="recommendation-card__title">{{ rec.job.title }}</h5>
                    {% if rec.common_skills %}
                      <p class="recommendation-card__subtitle">Matching skills</p>
                      <div class="skill-badge-group">
                        {% for skill in rec.common_skills %}
                          <span class="skill-badge">{{ skill }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="recommendation-card__actions">
                    <a href="{% url 'jobs.show' id=rec.job.id %}" class="btn btn-outline-dark btn-sm">View job</a>
                    <form method="post" action="{% url 'jobs.start_application' id=rec.job.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="user_note" value="">
                      <button type="submit" class="btn btn-primary btn-sm recommendation-card__apply">Apply now</button>
                    </form>
                  </div>
                </article>
              {% endfor %}
            </div>
          </section>
        {% elif user.is_authenticated and user.is_job_seeker and template_data.recommendations_available and not template_data.recommendations_hidden %}
          <div class="alert alert-info" role="alert">
            We have job recommendations waiting. Update your filters or click “Show recommendations” to view them again.
          </div>
        {% endif %}

        <section class="job-results">
          <div class="job-results-header">
            {% if user.is_authenticated and user.is_job_seeker %}
              <p class="job-results-eyebrow">Your activity</p>
              <h2>Jobs you've saved or applied to</h2>
              <p class="job-results-description">Keep tabs on the opportunities you’re already tracking.</p>
            {% elif user.is_authenticated and user.is_recruiter %}
              <p class="job-results-eyebrow">Your listings</p>
              <h2>Roles you've posted</h2>
              <p class="job-results-description">Review the positions you’re hiring for and make updates as needed.</p>
            {% else %}
              <p class="job-results-eyebrow">Your matches</p>
              <h2>Highlighted roles</h2>
              <p class="job-results-description">Jobs that align closely with your filters show up here first.</p>
            {% endif %}
          </div>
          <div class="job-card-grid">
            {% for job in context.user_jobs %}
              {% include 'jobs/partials/job_card.html' with job=job %}
            {% empty %}
              <p class="text-muted mb-0">You have not saved or applied to any roles that match these filters yet.</p>
            {% endfor %}
          </div>
        </section>

        <section class="job-results mt-5">
          <div class="job-results-header">
            <p class="job-results-eyebrow">More to explore</p>
            <h2>Discover additional opportunities</h2>
            <p class="job-results-description">Browse a broader set of roles that fit your current filters.</p>
          </div>
          <div class="job-card-grid">
            {% for job in context.other_jobs %}
              {% include 'jobs/partials/job_card.html' with job=job %}
            {% empty %}
              <p class="text-muted mb-0">No additional roles match your filters right now. Try widening your search.</p>
            {% endfor %}
          </div>
        </section>
      </div>
    </div>
  </div>
</section>

<!-- Skills Chips JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const skillInput = document.getElementById('skillInput');
  const skillsChips = document.getElementById('skillsChips');
  const searchForm = document.getElementById('searchForm');
  const hiddenSkillsInput = document.querySelector('input[name="skills"]');

  // Handle skill input
  skillInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      addSkill(this.value.trim());
      this.value = '';
    }
  });

  skillInput.addEventListener('input', function() {
    const value = this.value.trim();
    if (value.endsWith(',')) {
      addSkill(value.slice(0, -1).trim());
      this.value = '';
    }
  });

  // Handle datalist selection
  skillInput.addEventListener('change', function() {
    if (this.value) {
      addSkill(this.value.trim());
      this.value = '';
    }
  });

  function addSkill(skill) {
    if (!skill) return;
    
    // Check if skill already exists
    const existingSkills = Array.from(skillsChips.querySelectorAll('input[name="skill"]')).map(input => input.value);
    if (existingSkills.includes(skill)) return;

    // Create chip
    const chip = document.createElement('span');
    chip.className = 'skill-badge d-flex align-items-center gap-1 skill-chip';
    chip.style.fontSize = '0.9rem';
    chip.style.padding = '0.5rem 0.75rem';
    chip.innerHTML = `
      ${skill}
      <input type="hidden" name="skill" value="${skill}">
      <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;" onclick="removeSkill(this)" aria-label="Remove"></button>
    `;
    skillsChips.appendChild(chip);
    
    // Auto-submit
    // searchForm.submit();
  }
});

function removeSkill(button) {
  button.closest('.skill-chip').remove();
  // document.getElementById('searchForm').submit();
}
</script>

<style>
.hover-shadow {
  transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.skill-badge-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.skill-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background-color: #5D61EA;
  color: white;
  border-radius: 1rem;
  font-size: 0.85rem;
  font-weight: 500;
}

.skill-badge-sm {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  background-color: #e7e7ff;
  color: #5D61EA;
  border-radius: 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}

.skill-chip {
  cursor: default;
}
</style>

{% endblock content %}
