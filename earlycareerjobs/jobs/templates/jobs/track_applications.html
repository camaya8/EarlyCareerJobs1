{% extends 'base.html' %}
{% load static %}

{% block title %}Track Applications{% endblock %}

{% block content %}
<section class="application-tracker py-5">
  <div class="container">
    <div class="tracker-hero text-center mb-5">
      <span class="tracker-eyebrow text-uppercase">Application center</span>
      <h1 class="tracker-title h2 mb-2">Track your applications</h1>
      <p class="tracker-subtitle text-muted mb-0">Monitor where every opportunity stands and stay ready for the next step.</p>
    </div>

    <div class="row row-cols-2 row-cols-md-3 row-cols-xl-6 g-3 g-lg-4 tracker-summary mb-5">
      <div class="col">
        <div class="tracker-summary-card">
          <p class="summary-label text-uppercase">Total</p>
          <p class="summary-value">{{ total_applications }}</p>
        </div>
      </div>
      <div class="col">
        <div class="tracker-summary-card tracker-summary-card--applied">
          <p class="summary-label text-uppercase">Applied</p>
          <p class="summary-value">{{ stats.APPLIED|default:0 }}</p>
        </div>
      </div>
      <div class="col">
        <div class="tracker-summary-card tracker-summary-card--review">
          <p class="summary-label text-uppercase">Review</p>
          <p class="summary-value">{{ stats.REVIEW|default:0 }}</p>
        </div>
      </div>
      <div class="col">
        <div class="tracker-summary-card tracker-summary-card--interview">
          <p class="summary-label text-uppercase">Interview</p>
          <p class="summary-value">{{ stats.INTERVIEW|default:0 }}</p>
        </div>
      </div>
      <div class="col">
        <div class="tracker-summary-card tracker-summary-card--offer">
          <p class="summary-label text-uppercase">Offers</p>
          <p class="summary-value">{{ stats.OFFER|default:0 }}</p>
        </div>
      </div>
      <div class="col">
        <div class="tracker-summary-card tracker-summary-card--closed">
          <p class="summary-label text-uppercase">Closed</p>
          <p class="summary-value">{{ stats.CLOSED|default:0 }}</p>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm application-results-card">
      <div class="card-header bg-transparent border-0 px-4 pt-4 pb-0">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
          <div>
            <span class="application-results-eyebrow text-uppercase">Your progress</span>
            <h2 class="h5 mb-0">Applications overview</h2>
            <p class="text-muted mb-0">Follow up on conversations, interviews, and offers without losing momentum.</p>
          </div>
        </div>
      </div>
      <div class="card-body px-0">
        {% for application in applications %}
          <article class="application-item px-0">
            <div class="application-item__layout d-flex flex-column flex-md-row align-items-md-start gap-4 px-4 py-4">
              <div class="application-item__primary flex-grow-1">
                <div class="application-item__header d-flex flex-column flex-md-row flex-wrap align-items-md-center gap-2 mb-3">
                  <div class="application-company text-uppercase text-muted fw-semibold me-md-2">
                    {% for user in application.job.users.all %}
                      {% if user.is_recruiter %}
                        {{ user.company_name }}
                      {% endif %}
                    {% endfor %}
                  </div>
                  &nbsp;&nbsp;|&nbsp;&nbsp;
                  <h3 class="h5 mb-0">{{ application.job.title }}</h3>
                  &nbsp;&nbsp;|&nbsp;&nbsp;
                  {% if application.status == 'APPLIED' %}
                    <span class="badge rounded-pill active_application_status">Applied</span>
                  {% elif application.status == 'REVIEW' %}
                    <span class="badge rounded-pill review_application_status">Review</span>
                  {% elif application.status == 'INTERVIEW' %}
                    <span class="badge rounded-pill interview_application_status">Interview</span>
                  {% elif application.status == 'OFFER' %}
                    <span class="badge rounded-pill offer_application_status">Offer</span>
                  {% elif application.status == 'CLOSED' %}
                    <span class="badge rounded-pill closed_application_status">Closed</span>
                  {% else %}
                    <span class="badge rounded-pill error_application_status">No state</span>
                  {% endif %}
                </div>
                <div class="application-item__details d-flex flex-column gap-3">
                  <ul class="application-meta list-inline text-muted mb-0">
                    {% if application.job.city or application.job.state or application.job.country %}
                      <li class="list-inline-item">
                        <i class="bi bi-geo-alt me-1"></i>
                        {{ application.job.city }}{% if application.job.city and application.job.state %}, {% endif %}{{ application.job.state }}
                        {% if application.job.country %}{% if application.job.city or application.job.state %}, {% endif %}{{ application.job.country }}{% endif %}
                      </li>
                    {% endif %}
                    {% if application.date %}
                      <li class="list-inline-item">
                        <i class="bi bi-calendar-check me-1"></i>
                        Applied {{ application.date|date:"M j, Y" }}
                      </li>
                    {% endif %}
                  </ul>
                  {% if application.user_note != "" %}
                    <div class="application-note">
                      <span class="application-note__label text-uppercase text-muted">Personal note</span>
                      <p class="application-note__body mb-0">{{ application.user_note|truncatewords:20 }}</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </article>
        {% empty %}
          <div class="application-empty text-center px-4 py-5">
            <div class="application-empty__icon mx-auto mb-3">
              <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <path d="M8 7h8"></path>
                <path d="M8 11h8"></path>
                <path d="M8 15h5"></path>
              </svg>
            </div>
            <h3 class="h5 mb-2">No applications tracked yet</h3>
            <p class="text-muted mb-0">Apply to your next role and it will appear here so you can follow each step.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusForms = document.querySelectorAll('.status-update-form');

    statusForms.forEach(form => {
        const select = form.querySelector('select');
        const originalValue = select.value;

        select.addEventListener('change', function() {
            if (confirm('Are you sure you want to update the status?')) {
                form.submit();
            } else {
                select.value = originalValue;
            }
        });
    });
});
</script>
{% endblock %}
